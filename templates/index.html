<!DOCTYPE html>
<html>
<head>
    <title>D&D 5e Character Builder</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #121212; color: #e0e0e0; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #333; border-radius: 5px; background-color: #1e1e1e; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .stat-box { padding: 10px; border: 1px solid #333; text-align: center; background-color: #2a2a2a; color: #e0e0e0; }
        button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        button.save-stats-button { background-color: #2196F3; }
        button.save-stats-button:hover { background-color: #0b7dda; }
        button.clear-button { background-color: #f44336; }
        button.clear-button:hover { background-color: #d32f2f; }
        textarea { width: 100%; height: 100px; margin: 10px 0; background-color: #2a2a2a; color: #e0e0e0; border: 1px solid #333; }
        input[type="text"] { width: 100%; margin: 10px 0; padding: 8px; background-color: #2a2a2a; color: #e0e0e0; border: 1px solid #333; }
        select { width: 100%; margin: 10px 0; padding: 8px; background-color: #2a2a2a; color: #e0e0e0; border: 1px solid #333; }
        .description { font-size: 0.9em; color: #b0b0b0; }
        .stat-input { width: 50px; }
    </style>
</head>
<body>
    <div class="section">
        <h2>Character Details</h2>
        <div>
            <label for="characterName">Character Name:</label>
            <input type="text" id="characterName" placeholder="Enter character name...">
        </div>
        <div>
            <label for="characterClass">Character Class:</label>
            <select id="characterClass">
                <option value="Barbarian">Barbarian (Hit Die: d12)</option>
                <option value="Fighter">Fighter (Hit Die: d10)</option>
                <option value="Paladin">Paladin (Hit Die: d10)</option>
                <option value="Ranger">Ranger (Hit Die: d10)</option>
                <option value="Artificer">Artificer (Hit Die: d8)</option>
                <option value="Bard">Bard (Hit Die: d8)</option>
                <option value="Cleric">Cleric (Hit Die: d8)</option>
                <option value="Druid">Druid (Hit Die: d8)</option>
                <option value="Monk">Monk (Hit Die: d8)</option>
                <option value="Rogue">Rogue (Hit Die: d8)</option>
                <option value="Warlock">Warlock (Hit Die: d8)</option>
                <option value="Sorcerer">Sorcerer (Hit Die: d6)</option>
                <option value="Wizard">Wizard (Hit Die: d6)</option>
            </select>
        </div>
        <div>
            <label for="characterRace">Character Race:</label>
            <select id="characterRace">
                <option value="Human">Human</option>
                <option value="Elf">Elf</option>
                <option value="Dwarf">Dwarf</option>
                <option value="Halfling">Halfling</option>
                <option value="Dragonborn">Dragonborn</option>
                <option value="Gnome">Gnome</option>
                <option value="Half-Elf">Half-Elf</option>
                <option value="Half-Orc">Half-Orc</option>
                <option value="Tiefling">Tiefling</option>
            </select>
        </div>
    </div>

    <div class="section">
        <h2>Character Stats</h2>
        <button onclick="generateStats()">Generate New Stats</button>
        <span class="description">Stats generated by rolling 4d6 and dropping the lowest die.</span>
        <div id="statsDisplay" class="stats-grid"></div>
    </div>

    <div class="section">
        <h2>AC</h2>
        <div id="acDisplay"></div>
        <span class="description">Base AC for a non-armored character is 10 + Dexterity modifier.</span>
    </div>

    <div class="section">
        <h2>HP</h2>
        <div id="hpDisplay"></div>
        <span class="description">HP calculated based on hit die and Constitution modifier.</span>
    </div>

    <div class="section">
        <button onclick="saveStatsToNotes()" class="save-stats-button">Save Stats to Notes</button>
    </div>

    <div class="section">
        <h2>Character Notes</h2>
        <textarea id="noteContent" placeholder="Enter your notes here..."></textarea>
        <button onclick="saveNote()">Save Note</button>
        <button onclick="clearNotes()" class="clear-button">Clear</button>
    </div>

    <script>
        let statsData = {};
        let currentStats = {};

        function calculateModifier(score) {
            const modifier = Math.floor((score - 10) / 2);
            return modifier >= 0 ? `+${modifier}` : modifier;
        }

        function calculateHP(conMod, initialHP) {
            // Adjust HP based on Constitution modifier
            return initialHP + parseInt(conMod, 10);
        }

        function calculateAC(dexMod) {
            // Base AC for a non-armored character is 10 + Dexterity modifier
            return 10 + parseInt(dexMod, 10);
        }

        function randomRolls(die, times) {
            const rolls = [];
            for (let i = 0; i < times; i++) {
                rolls.push(Math.floor(Math.random() * die) + 1);
            }
            return rolls;
        }

        function sum(array) {
            return array.reduce((acc, val) => acc + val, 0);
        }

        function generateStats() {
            const characterClassOption = document.getElementById('characterClass').selectedOptions[0].text;
            const characterClass = document.getElementById('characterClass').value;
            const characterRace = document.getElementById('characterRace').value;
            
            // Extract the hit die from the selected option text
            const hitDieMatch = characterClassOption.match(/\(Hit Die: (d\d+)\)/);
            const hitDie = hitDieMatch ? hitDieMatch[1] : 'd6'; // Default to d6 if no match found

            fetch('/generate-stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ class: characterClass, hitDie: hitDie })
            })
            .then(response => response.json())
            .then(data => {
                let html = '';
                for (const [stat, value] of Object.entries(data.stats)) {
                    html += `
                        <div class="stat-box">
                            <strong>${stat}</strong><br>
                            Score: <input type="number" class="stat-input" id="stat-${stat.toLowerCase()}" value="${value}" oninput="updateStats('${stat}')"><br>
                            Modifier: <span id="modifier-${stat.toLowerCase()}">${data.modifiers[stat]}</span>
                        </div>
                    `;
                }
                document.getElementById('statsDisplay').innerHTML = html;
                document.getElementById('acDisplay').innerText = `AC: ${data.ac}`;
                document.getElementById('hpDisplay').innerText = `HP: ${data.hp}`;

                // Store stats data for later use
                statsData = {
                    characterClass: characterClass,
                    characterRace: characterRace,
                    stats: data.stats,
                    modifiers: data.modifiers,
                    ac: data.ac,
                    hp: data.hp,
                    initialHP: data.hp  // Store initial HP for adjustment
                };

                // Store current stats for input updates
                currentStats = { ...data.stats };
            });
        }

        function updateStats(stat) {
            const input = document.getElementById(`stat-${stat.toLowerCase()}`);
            const value = parseInt(input.value, 10);
            const modifier = calculateModifier(value);

            document.getElementById(`modifier-${stat.toLowerCase()}`).innerText = modifier;
            currentStats[stat] = value;

            // Recalculate AC and HP
            const dexMod = calculateModifier(currentStats.Dexterity);
            const conMod = calculateModifier(currentStats.Constitution);

            const ac = calculateAC(parseInt(dexMod, 10));
            const hp = calculateHP(parseInt(conMod, 10), statsData.initialHP);

            document.getElementById('acDisplay').innerText = `AC: ${ac}`;
            document.getElementById('hpDisplay').innerText = `HP: ${hp}`;

            // Update statsData with new values
            statsData.modifiers = { ...statsData.modifiers, [stat]: modifier };
            statsData.ac = ac;
            statsData.hp = hp;
        }

        function saveStatsToNotes() {
            const characterName = document.getElementById('characterName').value;
            const characterRace = document.getElementById('characterRace').value;
            if (Object.keys(statsData).length === 0) {
                alert('Please generate stats first.');
                return;
            }

            // Create character information
            let character_info = `Character Name: ${characterName}\n`;
            character_info += `Character Class: ${statsData.characterClass}\n`;
            character_info += `Character Race: ${characterRace}\n`;
            character_info += "Stats:\n";
            for (const [stat, value] of Object.entries(statsData.stats)) {
                character_info += `  - ${stat}: ${value} (${statsData.modifiers[stat]})\n`;
            }
            character_info += `AC: ${statsData.ac}\n`;
            character_info += `HP: ${statsData.hp}\n`;

            // Append character information to the notes section
            const noteContent = document.getElementById('noteContent');
            noteContent.value += `${character_info}\n`;
        }

        function saveNote() {
            const content = document.getElementById('noteContent').value;
            if (content.trim() === '') {
                alert('Notes are empty. Please add some notes before saving.');
                return;
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(content)
                .then(() => {
                    alert('Notes copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy notes: ', err);
                    alert('Failed to copy notes to clipboard.');
                });
        }

        function clearNotes() {
            document.getElementById('noteContent').value = '';
        }
    </script>
</body>
</html>
